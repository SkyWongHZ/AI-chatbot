# 对话历史持久化实现文档

## 需求背景

原有的 AI 聊天服务将对话历史存储在内存中（`AIService.conversationHistory` 数组），存在以下问题：
- 服务重启后数据丢失
- 所有用户共享同一个对话历史，无法实现用户隔离
- 无法在多设备间同步对话记录

**目标**：将对话历史持久化到 MongoDB 数据库，实现用户隔离。

---

## 技术选型

| 技术 | 说明 |
|------|------|
| **Prisma** | Node.js ORM，提供类型安全的数据库操作 |
| **MongoDB** | NoSQL 数据库，适合存储非结构化的对话数据 |
| **UUID** | 前端生成唯一用户标识 |
| **localStorage** | 前端持久化 userId |

---

## 数据模型设计

```prisma
// prisma/schema.prisma

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// 对话消息（嵌入类型）
type Message {
  role      String   // 'system' | 'user' | 'assistant'
  content   String
  createdAt DateTime @default(now())
}

// 用户对话记录
model Conversation {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    // 用户标识（UUID）
  messages  Message[] // 对话消息列表
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
}
```

---

## 实现步骤

### 1. 安装依赖

```bash
cd packages/server
npm install prisma @prisma/client
```

### 2. 初始化 Prisma

```bash
npx prisma init
```

### 3. 配置数据库连接

修改 `packages/server/.env`：

```env
DATABASE_URL="mongodb://用户名:密码@主机:27017/ai-chatbot?authSource=admin&directConnection=true"
```

### 4. 同步 Schema 到数据库

```bash
npx prisma db push
npx prisma generate
```

### 5. 创建 Prisma Client 实例

**文件**: `packages/server/src/db/prisma.ts`

```typescript
import { PrismaClient } from '../generated/prisma/client'

const prisma = new PrismaClient()

export default prisma
```

### 6. 修改 AIService

**文件**: `packages/server/src/services/aiService.ts`

主要改动：
- 移除内存中的 `conversationHistory` 数组
- `chat(userId, message)` - 从数据库读取历史，调用 AI，保存新消息
- `getHistory(userId)` - 获取指定用户的对话历史
- `clearHistory(userId)` - 清空指定用户的对话历史

### 7. 修改 Controller

**文件**: `packages/server/src/controllers/chatController.ts`

- `chat` 方法从请求体获取 `userId`
- 新增 `getHistory` 方法
- 新增 `clearHistory` 方法

### 8. 修改路由

**文件**: `packages/server/src/routes/chat.ts`

```typescript
router.post('/', chatController.chat)
router.get('/history', chatController.getHistory)
router.delete('/history', chatController.clearHistory)
```

### 9. 启动时连接数据库

**文件**: `packages/server/src/app.ts`

```typescript
import prisma from './db/prisma'

async function start() {
  await prisma.$connect()
  console.log('Database connected')
  // ...
}
```

### 10. 前端生成 userId

**文件**: `packages/client/src/utils/user.ts`

```typescript
export function getUserId(): string {
  let userId = localStorage.getItem('userId')
  if (!userId) {
    userId = crypto.randomUUID()
    localStorage.setItem('userId', userId)
  }
  return userId
}
```

### 11. 前端 API 改造

**文件**: `packages/client/src/api/chat.ts`

```typescript
export const chatApi = {
  send(message: string, userId: string) {
    return request.post('/api/chat', { message, userId })
  },
  getHistory(userId: string) {
    return request.get('/api/chat/history', { params: { userId } })
  },
  clearHistory(userId: string) {
    return request.delete('/api/chat/history', { data: { userId } })
  }
}
```

### 12. 前端 Store 改造

**文件**: `packages/client/src/store/chat.ts`

- 新增 `loadHistory()` 方法，页面加载时调用
- `sendMessage()` 携带 userId

---

## API 接口说明

### 发送消息

```
POST /api/chat
Content-Type: application/json

{
  "message": "你好",
  "userId": "550e8400-e29b-41d4-a716-446655440000"
}

Response:
{
  "data": {
    "reply": "你好！有什么我可以帮助你的吗？"
  }
}
```

### 获取对话历史

```
GET /api/chat/history?userId=550e8400-e29b-41d4-a716-446655440000

Response:
{
  "data": {
    "history": [
      { "role": "user", "content": "你好" },
      { "role": "assistant", "content": "你好！有什么我可以帮助你的吗？" }
    ]
  }
}
```

### 清空对话历史

```
DELETE /api/chat/history
Content-Type: application/json

{
  "userId": "550e8400-e29b-41d4-a716-446655440000"
}

Response:
{
  "data": {
    "success": true
  }
}
```

---

## 文件改动清单

| 文件路径 | 操作 |
|---------|------|
| `packages/server/package.json` | 添加 prisma 依赖 |
| `packages/server/prisma/schema.prisma` | 新建 |
| `packages/server/src/db/prisma.ts` | 新建 |
| `packages/server/src/services/aiService.ts` | 修改 |
| `packages/server/src/controllers/chatController.ts` | 修改 |
| `packages/server/src/routes/chat.ts` | 修改 |
| `packages/server/src/app.ts` | 修改 |
| `packages/server/.env` | 修改 |
| `packages/client/src/utils/user.ts` | 新建 |
| `packages/client/src/api/chat.ts` | 修改 |
| `packages/client/src/store/chat.ts` | 修改 |
| `packages/client/src/views/Home.vue` | 修改 |

---

## 测试验证

### Postman 测试

1. **发送消息**
   - Method: POST
   - URL: `http://localhost:3000/api/chat`
   - Body: `{"message": "你好", "userId": "test-user-001"}`

2. **获取历史**
   - Method: GET
   - URL: `http://localhost:3000/api/chat/history?userId=test-user-001`

3. **清空历史**
   - Method: DELETE
   - URL: `http://localhost:3000/api/chat/history`
   - Body: `{"userId": "test-user-001"}`

### 启动服务

```bash
# 后端
cd packages/server
npm run dev

# 前端
cd packages/client
npm run dev
```

### 功能验证

1. 发送几条消息
2. 刷新页面，验证对话历史是否恢复
3. 打开新的隐身窗口，验证是新用户（无历史记录）
4. 检查 localStorage 中的 userId
5. 使用 MongoDB 客户端（如 Navicat）查看 Conversation 集合数据

---

## 注意事项

1. **MongoDB 连接字符串**：如果 MongoDB 是 Replica Set 模式，需要添加 `directConnection=true` 参数
2. **历史记录限制**：默认保留最近 20 条消息，防止 token 超限
3. **userId 安全性**：当前方案前端生成 UUID，适合匿名用户场景；如需用户登录，应改为后端生成并关联用户账号
